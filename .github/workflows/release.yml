name: Build & Release

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*'

permissions:
  contents: write

env:
  GO_VERSION: '1.25.7'

jobs:
  # ─── Linux deb/rpm (amd64 + arm64) ────────────────────────────────
  linux-packages:
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            pkg_arch: amd64
            cc: gcc
            libpcap_pkg: libpcap-dev
          - goos: linux
            goarch: arm64
            pkg_arch: arm64
            cc: aarch64-linux-gnu-gcc
            libpcap_pkg: libpcap-dev:arm64

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install cross-compilation tools
        if: matrix.goarch == 'arm64'
        run: |
          sudo dpkg --add-architecture arm64
          # Pin ALL existing apt sources to amd64 only
          # Handle .list files
          for f in /etc/apt/sources.list.d/*.list; do
            [ -f "$f" ] && sudo sed -i '/^deb /{/\[/!s|^deb |deb [arch=amd64] |}' "$f" 2>/dev/null || true
          done
          [ -f /etc/apt/sources.list ] && sudo sed -i '/^deb /{/\[/!s|^deb |deb [arch=amd64] |}' /etc/apt/sources.list 2>/dev/null || true
          # Handle DEB822 .sources files (Ubuntu 24.04+)
          for f in /etc/apt/sources.list.d/*.sources; do
            [ -f "$f" ] && sudo sed -i '/^Architectures:/!{/^Types:/a Architectures: amd64}' "$f" 2>/dev/null || true
            [ -f "$f" ] && grep -q '^Architectures:' "$f" || sudo sed -i '/^Types:/a Architectures: amd64' "$f" 2>/dev/null || true
          done
          # Add arm64 ports (covers main, updates, security, backports)
          CODENAME=$(lsb_release -cs)
          printf '%s\n' \
            "deb [arch=arm64] http://ports.ubuntu.com/ ${CODENAME} main restricted universe" \
            "deb [arch=arm64] http://ports.ubuntu.com/ ${CODENAME}-updates main restricted universe" \
            "deb [arch=arm64] http://ports.ubuntu.com/ ${CODENAME}-security main restricted universe" \
            "deb [arch=arm64] http://ports.ubuntu.com/ ${CODENAME}-backports main restricted universe" \
            | sudo tee /etc/apt/sources.list.d/arm64-ports.list
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu libpcap-dev:arm64

      - name: Install libpcap (native)
        if: matrix.goarch == 'amd64'
        run: sudo apt-get install -y libpcap-dev

      - name: Install nfpm
        run: |
          go install github.com/goreleaser/nfpm/v2/cmd/nfpm@latest

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "1"
          CC: ${{ matrix.cc }}
        run: |
          VERSION="${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || github.sha }}"
          go build -ldflags="-s -w -X main.version=${VERSION}" -o bandwidth-monitor .

      - name: Prepare packaging service file
        run: |
          sed -e 's|/opt/bandwidth-monitor/bandwidth-monitor|/usr/bin/bandwidth-monitor|' \
              -e 's|EnvironmentFile=/opt/bandwidth-monitor/.env|EnvironmentFile=-/etc/bandwidth-monitor/env|' \
              -e 's|WorkingDirectory=/opt/bandwidth-monitor|WorkingDirectory=/var/lib/bandwidth-monitor|' \
              -e 's|ReadOnlyPaths=/opt/bandwidth-monitor||' \
              bandwidth-monitor.service > bandwidth-monitor-pkg.service

      - name: Build deb
        env:
          VERSION: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || format('0.0.0-{0}', github.sha) }}
          GOARCH: ${{ matrix.pkg_arch }}
        run: |
          export VERSION="${VERSION#v}"
          nfpm package -p deb -f nfpm.yaml

      - name: Build rpm
        env:
          VERSION: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || format('0.0.0-{0}', github.sha) }}
          GOARCH: ${{ matrix.pkg_arch }}
        run: |
          export VERSION="${VERSION#v}"
          nfpm package -p rpm -f nfpm.yaml

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.goarch }}
          path: |
            *.deb
            *.rpm

  # ─── OpenWrt (multiple targets) ────────────────────────────────────
  openwrt:
    strategy:
      matrix:
        include:
          # ── OpenWrt 23.05 (stable) ──
          - sdk_url_suffix: x86/64
            arch: x86_64
            goarch: amd64
            cc_prefix: x86_64-openwrt-linux-musl
            release: "23.05.5"
            pkg_format: ipk
            base_url: "https://downloads.openwrt.org/releases/23.05.5/targets"
          - sdk_url_suffix: rockchip/armv8
            arch: aarch64_generic
            goarch: arm64
            cc_prefix: aarch64-openwrt-linux-musl
            release: "23.05.5"
            pkg_format: ipk
            base_url: "https://downloads.openwrt.org/releases/23.05.5/targets"
          - sdk_url_suffix: ath79/generic
            arch: mips_24kc
            goarch: mips
            gomips: softfloat
            cc_prefix: mips-openwrt-linux-musl
            release: "23.05.5"
            pkg_format: ipk
            base_url: "https://downloads.openwrt.org/releases/23.05.5/targets"
          - sdk_url_suffix: ramips/mt7621
            arch: mipsel_24kc
            goarch: mipsle
            gomips: softfloat
            cc_prefix: mipsel-openwrt-linux-musl
            release: "23.05.5"
            pkg_format: ipk
            base_url: "https://downloads.openwrt.org/releases/23.05.5/targets"
          - sdk_url_suffix: mediatek/filogic
            arch: aarch64_cortex-a53
            goarch: arm64
            cc_prefix: aarch64-openwrt-linux-musl
            release: "23.05.5"
            pkg_format: ipk
            base_url: "https://downloads.openwrt.org/releases/23.05.5/targets"
          # ── OpenWrt SNAPSHOT (nightly, uses apk) ──
          - sdk_url_suffix: x86/64
            arch: x86_64-snapshot
            goarch: amd64
            cc_prefix: x86_64-openwrt-linux-musl
            release: "snapshot"
            pkg_format: apk
            base_url: "https://downloads.openwrt.org/snapshots/targets"
          - sdk_url_suffix: rockchip/armv8
            arch: aarch64_generic-snapshot
            goarch: arm64
            cc_prefix: aarch64-openwrt-linux-musl
            release: "snapshot"
            pkg_format: apk
            base_url: "https://downloads.openwrt.org/snapshots/targets"
          - sdk_url_suffix: mediatek/filogic
            arch: aarch64_cortex-a53-snapshot
            goarch: arm64
            cc_prefix: aarch64-openwrt-linux-musl
            release: "snapshot"
            pkg_format: apk
            base_url: "https://downloads.openwrt.org/snapshots/targets"

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential file wget fakeroot

      - name: Download and extract OpenWrt SDK
        run: |
          SDK_URL="${{ matrix.base_url }}/${{ matrix.sdk_url_suffix }}"
          SDK_FILE=$(curl -sf "$SDK_URL/sha256sums" | grep 'openwrt-sdk-' | grep -oP 'openwrt-sdk-[^\s*]+\.tar\.\w+' | head -1)
          echo "Downloading $SDK_URL/$SDK_FILE"
          wget -q "$SDK_URL/$SDK_FILE"
          tar xf "$SDK_FILE"
          rm -f "$SDK_FILE"
          echo "SDK_DIR=$(cd $(find . -maxdepth 1 -type d -name 'openwrt-sdk-*' | head -1) && pwd)" >> $GITHUB_ENV

      - name: Prepare libpcap for cross-compilation
        run: |
          TOOLCHAIN_DIR=$(find "$SDK_DIR/staging_dir" -maxdepth 1 -name 'toolchain-*' -type d | head -1)
          TOOLCHAIN_DIR=$(cd "$TOOLCHAIN_DIR" && pwd)
          TARGET_DIR=$(find "$SDK_DIR/staging_dir" -maxdepth 1 -name 'target-*' -type d | head -1)
          TARGET_DIR=$(cd "$TARGET_DIR" && pwd)

          export PATH="$TOOLCHAIN_DIR/bin:$PATH"
          export STAGING_DIR="$SDK_DIR/staging_dir"

          # Build libpcap from source for the target
          if [ ! -f "$TARGET_DIR/usr/include/pcap.h" ]; then
            echo "Building libpcap from source..."
            PCAP_VER="1.10.5"
            wget -q "https://www.tcpdump.org/release/libpcap-${PCAP_VER}.tar.xz"
            tar xf "libpcap-${PCAP_VER}.tar.xz"
            cd "libpcap-${PCAP_VER}"
            CC=${{ matrix.cc_prefix }}-gcc \
            AR=${{ matrix.cc_prefix }}-ar \
            RANLIB=${{ matrix.cc_prefix }}-ranlib \
            ./configure \
              --host=${{ matrix.cc_prefix }} \
              --prefix="$TARGET_DIR/usr" \
              --with-pcap=linux \
              --without-libnl \
              --disable-shared \
              --enable-static
            make -j$(nproc)
            make install
            cd "${{ github.workspace }}"
            rm -rf "libpcap-${PCAP_VER}" "libpcap-${PCAP_VER}.tar.xz"
          fi

          echo "pcap.h location:"
          find "$TARGET_DIR" -name 'pcap.h' -type f 2>/dev/null | head -3
          echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          echo "TARGET_DIR=$TARGET_DIR" >> $GITHUB_ENV
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

      - name: Build binary with SDK toolchain
        run: |
          export STAGING_DIR="$SDK_DIR/staging_dir"
          export CGO_ENABLED=1
          export GOOS=linux
          export GOARCH=${{ matrix.goarch }}
          export GOMIPS=${{ matrix.gomips }}
          export CC=${{ matrix.cc_prefix }}-gcc
          export CXX=${{ matrix.cc_prefix }}-g++
          export CGO_CFLAGS="-I$TARGET_DIR/usr/include -I$TOOLCHAIN_DIR/usr/include -I$TOOLCHAIN_DIR/include"
          export CGO_LDFLAGS="-L$TARGET_DIR/usr/lib -L$TOOLCHAIN_DIR/usr/lib -L$TOOLCHAIN_DIR/lib"

          VERSION="${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || github.sha }}"
          go build -ldflags="-s -w -X main.version=${VERSION}" -o bandwidth-monitor .
          file bandwidth-monitor
          echo "BINARY=${{ github.workspace }}/bandwidth-monitor" >> $GITHUB_ENV

      - name: Package for OpenWrt
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="0.0.0_git$(date +%Y%m%d)"
          fi
          ARCH="${{ matrix.arch }}"
          ARCH="${ARCH%-snapshot}"
          WORKSPACE="${{ github.workspace }}"
          PKG_FORMAT="${{ matrix.pkg_format }}"

          PKG_DIR=$(mktemp -d)
          BUILD_DIR=$(mktemp -d)
          mkdir -p "$PKG_DIR/usr/bin"
          mkdir -p "$PKG_DIR/etc/bandwidth-monitor"
          mkdir -p "$PKG_DIR/etc/init.d"
          mkdir -p "$WORKSPACE/pkg-out"

          cp "$BINARY" "$PKG_DIR/usr/bin/bandwidth-monitor"
          cp "$WORKSPACE/env.example" "$PKG_DIR/etc/bandwidth-monitor/env"
          cp "$WORKSPACE/packaging/openwrt-files/bandwidth-monitor.init" "$PKG_DIR/etc/init.d/bandwidth-monitor"
          chmod 755 "$PKG_DIR/usr/bin/bandwidth-monitor" "$PKG_DIR/etc/init.d/bandwidth-monitor"
          chmod 600 "$PKG_DIR/etc/bandwidth-monitor/env"

          if [ "$PKG_FORMAT" = "apk" ]; then
            # Download apk-tools v3 static binary for creating APK v3 packages
            wget -q "https://dl-cdn.alpinelinux.org/alpine/latest-stable/main/x86_64/APKINDEX.tar.gz" -O /tmp/APKINDEX.tar.gz
            APK_STATIC_VER=$(tar xzf /tmp/APKINDEX.tar.gz -O APKINDEX 2>/dev/null | awk '/^P:apk-tools-static$/{found=1} found && /^V:/{print $0; exit}' | cut -d: -f2)
            echo "Latest apk-tools-static version: $APK_STATIC_VER"
            wget -q "https://dl-cdn.alpinelinux.org/alpine/latest-stable/main/x86_64/apk-tools-static-${APK_STATIC_VER}.apk" -O /tmp/apk-static.apk
            cd /tmp && tar xzf apk-static.apk sbin/apk.static && cd "$WORKSPACE"
            APK=/tmp/sbin/apk.static

            BINSIZE=$(stat -c%s "$BINARY")
            BUILDDATE=$(date +%s)

            # apk mkpkg uses -I key:value for info, -F dir for files, -o for output
            APK_FILE="$WORKSPACE/pkg-out/bandwidth-monitor-${VERSION}-r1_${ARCH}.apk"
            cd "$PKG_DIR"
            $APK mkpkg \
              -I "name:bandwidth-monitor" \
              -I "version:${VERSION}-r1" \
              -I "description:Real-time network monitoring dashboard with embedded web UI" \
              -I "url:https://github.com/awlx/bandwidth-monitor" \
              -I "build-time:${BUILDDATE}" \
              -I "arch:${ARCH}" \
              -I "license:ISC" \
              -I "depends:libpcap" \
              -I "maintainer:Annika Wickert <awlx@users.noreply.github.com>" \
              -F "$PKG_DIR" \
              -o "$APK_FILE"
            ls -lh "$APK_FILE"
            file "$APK_FILE"
          else
            mkdir -p "$PKG_DIR/CONTROL"
            printf '%s\n' \
              "Package: bandwidth-monitor" \
              "Version: ${VERSION}" \
              "Architecture: ${ARCH}" \
              "Depends: libpcap" \
              "Maintainer: Annika Wickert <awlx@users.noreply.github.com>" \
              "Section: net" \
              "Description: Real-time network monitoring dashboard with embedded web UI" \
              > "$PKG_DIR/CONTROL/control"

            echo "/etc/bandwidth-monitor/env" > "$PKG_DIR/CONTROL/conffiles"

            tar czf "$BUILD_DIR/control.tar.gz" -C "$PKG_DIR/CONTROL" .
            tar czf "$BUILD_DIR/data.tar.gz" --owner=0 --group=0 -C "$PKG_DIR" usr etc
            echo "2.0" > "$BUILD_DIR/debian-binary"

            IPK_FILE="$WORKSPACE/pkg-out/bandwidth-monitor_${VERSION}_${ARCH}.ipk"
            cd "$BUILD_DIR"
            ar r "$IPK_FILE" debian-binary control.tar.gz data.tar.gz
            ls -lh "$IPK_FILE"
          fi

      - name: Upload OpenWrt package
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-${{ matrix.arch }}
          path: pkg-out/*

  # ─── GitHub Release (tags only) ────────────────────────────────────
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [linux-packages, openwrt]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.ipk
            artifacts/**/*.apk
            artifacts/**/*.tar.gz
